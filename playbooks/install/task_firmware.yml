- name: find firmware package
  find:
    path: "{{ resources_dir }}"
    recurse: no
    file_type: file
    use_regex: yes
    patterns: "{{ ansible_local.npu_info.product }}-.*{{ ansible_local.npu_info.model_number }}.*firmware.*.run"
  register: firmware_pkg

- debug:
    var: firmware_pkg
    verbosity: 1

- name: find upgrade tool
  find:
    path: /usr/local/Ascend/driver
    recurse: yes
    file_type: file
    use_regex: yes
    patterns: "upgrade-tool"
  register: up_tool

- name: message
  debug:
    msg:
    - "firmware install failed: driver not installed"
  failed_when: true
  when: up_tool.matched == 0 and firmware_pkg.matched > 0

- name: add run permission for firmware
  file:
    path: "{{ firmware_pkg.files[0].path }}"
    mode: a+x
  when: firmware_pkg.matched > 0

- name: install firmware
  shell: "{{ firmware_pkg.files[0].path }} --full --quiet"
  register: firmware_result
  when: firmware_pkg.matched > 0
  become: yes

- debug:
    var: firmware_result
    verbosity: 1
